<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mvxy Subtitle Admin Panel</title>
<style>
body {background:#0b1220;color:white;font-family:Arial;padding:20px;}
h2 {color:#00bfff;text-align:center;}
.box {background:#111827;padding:15px;border-radius:10px;margin-bottom:12px;}
input,select,button {width:100%;padding:10px;margin-top:6px;border-radius:6px;border:none;}
button {background:#00bfff;color:white;font-weight:bold;cursor:pointer;}
#status {margin-top:10px;font-size:14px;}
.link-box {margin-top:10px;background:#0f172a;padding:10px;border-radius:8px;font-size:13px;}
a {color:#00ff99;text-decoration:none;}
</style>
</head>
<body>

<h2>üé¨ Mvxy Subtitle Admin Panel</h2>

<div class="box">
  <label>GitHub Token</label>
  <input type="password" id="token" placeholder="Paste GitHub Token">
</div>

<div class="box">
  <label>Type</label>
  <select id="type">
    <option value="movie">Movie üé¨</option>
    <option value="tv">TV Series üì∫</option>
  </select>

  <label>Movie / Series Name</label>
  <input type="text" id="name" placeholder="Example: Smurf 2025 or ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂†‡∑í‡∂≠‡∑ä‚Äç‡∂ª‡∂¥‡∂ß‡∂∫">

  <label>Language</label>
  <select id="lang">
    <option value="eng">English</option>
    <option value="sin">Sinhala</option>
  </select>

  <label>Subtitle File (.srt / .vtt only)</label>
  <input type="file" id="file" accept=".srt,.vtt">

  <button onclick="uploadSubtitle()">Upload Subtitle</button>

  <div id="status"></div>
  <div id="linkResult"></div>
</div>

<script>
const owner = "mvxyoffcial-create";
const repo = "Mvxy-subtitles-database";
const branch = "main";
const siteUrl = "https://mvxyoffcial-create.github.io/Mvxy-subtitles-database/";

// ‚úÖ Convert any language name to safe URL slug (Sinhala + English)
function makeSlug(text) {
  return text
    .toLowerCase()
    .trim()
    .replace(/\s+/g, "-")           // spaces ‚Üí -
    .replace(/[^a-z0-9\-]/g, "")    // remove non-English chars
    .replace(/-+/g, "-");
}

async function uploadSubtitle() {
  const token = document.getElementById("token").value.trim();
  const type = document.getElementById("type").value;
  const name = document.getElementById("name").value.trim();
  const lang = document.getElementById("lang").value;
  const fileInput = document.getElementById("file").files[0];
  const status = document.getElementById("status");
  const linkResult = document.getElementById("linkResult");

  status.innerHTML = "";
  linkResult.innerHTML = "";

  if (!token || !name || !fileInput) {
    status.innerHTML = "‚ùå Please fill all fields!";
    return;
  }

  const ext = fileInput.name.split(".").pop().toLowerCase();
  if(ext !== "srt" && ext !== "vtt"){
    status.innerHTML = "‚ùå Only .srt and .vtt files allowed!";
    return;
  }

  // ‚úÖ Safe filename (works for Sinhala names too)
  const slug = makeSlug(name) || "subtitle";
  const newFileName = `${slug}-${lang}.${ext}`;

  const folder = type === "movie" ? "movies" : "tv";
  const path = `${folder}/${newFileName}`;

  status.innerHTML = "‚è≥ Uploading subtitle...";

  // ‚úÖ Convert file to base64 (safe method)
  const content = await fileInput.arrayBuffer();
  const base64Content = btoa(
    Array.from(new Uint8Array(content))
      .map(b => String.fromCharCode(b))
      .join("")
  );

  // ‚úÖ Encode path for GitHub API (IMPORTANT FIX)
  const apiPath = path.split("/").map(encodeURIComponent).join("/");

  const uploadRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${apiPath}`, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Upload subtitle",
      content: base64Content,
      branch: branch
    })
  });

  if (!uploadRes.ok) {
    const err = await uploadRes.text();
    status.innerHTML = "‚ùå Upload failed!<br>" + err;
    return;
  }

  // ‚úÖ Update data.json
  const dataUrl = `https://api.github.com/repos/${owner}/${repo}/contents/data.json`;
  const dataRes = await fetch(dataUrl, {
    headers: { "Authorization": `token ${token}` }
  });

  let oldData = [];
  let sha = null;

  if (dataRes.ok) {
    const dataJson = await dataRes.json();
    sha = dataJson.sha;
    oldData = JSON.parse(atob(dataJson.content));
  }

  const newItem = {
    type: type,
    name: name, // Sinhala name kept here ‚úÖ
    slug: slug,
    lang: lang === "eng" ? "English" : "Sinhala",
    file: path
  };

  oldData.push(newItem);

  const newContent = btoa(JSON.stringify(oldData, null, 2));

  await fetch(dataUrl, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update data.json",
      content: newContent,
      sha: sha,
      branch: branch
    })
  });

  status.innerHTML = "‚úÖ Uploaded successfully!";

  const finalLink = siteUrl + path;
  linkResult.innerHTML = `
    <div class="link-box">
      üîó Subtitle Link:<br>
      <a href="${finalLink}" target="_blank">${finalLink}</a><br><br>
      üìã Copy Link:<br>
      <input type="text" value="${finalLink}" style="width:100%;padding:6px;border-radius:6px;border:none;" onclick="this.select()">
    </div>
  `;
}
</script>

</body>
</html>
