<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mvxy Subtitle Admin</title>
<style>
body {background:#0b1220;color:white;font-family:Arial;padding:20px;}
h2 {color:#00bfff;text-align:center;}
.box {background:#111827;padding:15px;border-radius:10px;margin-bottom:12px;}
input,select,button {width:100%;padding:10px;margin-top:6px;border-radius:6px;border:none;}
button {background:#00bfff;color:white;font-weight:bold;cursor:pointer;}
#status {margin-top:10px;font-size:14px;}
</style>
</head>
<body>

<h2>üé¨ Mvxy Subtitle Admin Panel</h2>

<div class="box">
  <label>GitHub Token</label>
  <input type="password" id="token" placeholder="Paste GitHub Token">
</div>

<div class="box">
  <label>Type</label>
  <select id="type">
    <option value="movie">Movie üé¨</option>
    <option value="tv">TV Series üì∫</option>
  </select>

  <label>Movie / Series Name</label>
  <input type="text" id="name" placeholder="Example: Smurf 2025">

  <label>Language</label>
  <select id="lang">
    <option value="eng">English</option>
    <option value="sin">Sinhala</option>
  </select>

  <label>Subtitle File (.srt / .vtt)</label>
  <input type="file" id="file" accept=".srt,.vtt">

  <button onclick="uploadSubtitle()">Upload Subtitle</button>
  <div id="status"></div>
</div>

<script>
const owner = "mvxyoffcial-create";
const repo = "Mvxy-subtitles-database";
const branch = "main";

async function uploadSubtitle() {
  const token = document.getElementById("token").value;
  const type = document.getElementById("type").value;
  const name = document.getElementById("name").value.trim();
  const lang = document.getElementById("lang").value;
  const fileInput = document.getElementById("file").files[0];
  const status = document.getElementById("status");

  if (!token || !name || !fileInput) {
    status.innerHTML = "‚ùå Fill all fields!";
    return;
  }

  const ext = fileInput.name.split(".").pop(); // srt or vtt

  // ‚úÖ Auto rename file like: Smurf 2025 eng.srt
  const newFileName = `${name} ${lang}.${ext}`;

  const folder = type === "movie" ? "movies" : "tv";
  const path = `${folder}/${newFileName}`;

  status.innerHTML = "‚è≥ Uploading subtitle...";

  const content = await fileInput.arrayBuffer();
  const base64Content = btoa(String.fromCharCode(...new Uint8Array(content)));

  // Upload subtitle file to GitHub
  const uploadRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Upload subtitle",
      content: base64Content,
      branch: branch
    })
  });

  if (!uploadRes.ok) {
    status.innerHTML = "‚ùå Upload failed!";
    return;
  }

  // ‚úÖ Update data.json automatically
  const dataUrl = `https://api.github.com/repos/${owner}/${repo}/contents/data.json`;
  const dataRes = await fetch(dataUrl, {
    headers: { "Authorization": `token ${token}` }
  });

  const dataJson = await dataRes.json();
  const oldData = JSON.parse(atob(dataJson.content));

  const newItem = {
    type: type,
    name: name,
    lang: lang === "eng" ? "English" : "Sinhala",
    file: path
  };

  oldData.push(newItem);

  const newContent = btoa(JSON.stringify(oldData, null, 2));

  await fetch(dataUrl, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update data.json",
      content: newContent,
      sha: dataJson.sha,
      branch: branch
    })
  });

  status.innerHTML = "‚úÖ Uploaded & data.json updated successfully!";
}
</script>

</body>
</html>
